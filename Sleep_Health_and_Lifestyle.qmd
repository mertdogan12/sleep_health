---
title: "Sleep Health and Lifestyle"
author: "Mert Baki Dogan"
date: "`r Sys.Date()`"
format: 
  html: 
    toc: true
    toc_float: true
    embed-resources: true
    code-fold: true
    code-summary: "Code anzeigen"
---

```{r = packets, include=FALSE}
library(tidyverse)
library(tidymodels)
library(explore)
library(ranger)
library(corrplot)
```

# Aufgabenstellung und Daten verstehen

In dieser Arbeit soll untersucht werden, wie sich verschiedene Faktoren auf die Schlafqualität auswirken. Dabei geht es nicht nur darum, ob sich diese Faktoren auswirken, sondern auch wie stark ihr Einfluss ist.

Dazu steht uns der Datensatz *Sleep Health and Lifestyle Dataset* zur Verfügung. Dieser Datensatz enthält Informationen über den Lebensstile und die Schlafqualität verschiedener Personen. Er ist unter folgendem Link zu finden: <https://www.kaggle.com/datasets/uom190346a/sleep-health-and-lifestyle-dataset>

Zu Beginn formulieren wir zwei Thesen, die wir mit Hilfe des Datensatzes überprüfen möchen.

**These 1: Wenig Stress und viel Körperliche Aktivität hat einen großen Einfluss auf eine gute Schlafqualität**

**These 2: Mit dem Alter nimmt die Schlafqualität ab**

Diese Thesen sollen explorativ untersucht werden. Weitere Thesen werden sich eventuell bei der Sichtung der Daten ergeben.

Im nächsten Schritt werden die Daten eingelesen.

```{r, message=FALSE}
sleep_data <- read.csv("Sleep_health_and_lifestyle_dataset.csv")
```

Schauen wir uns die Daten zunächst einmal an.

```{r, message=FALSE}
knitr::kable(head(sleep_data), caption = "Das Spaltenformat des eingelesenen Datensatzes")
```

Der Datensatz hat **`r nrow(sleep_data)`** Zeilen und **`r ncol(sleep_data)`** Spalten.

Die Variablen haben folgende Bedeutung:

| Variable | Type | Bedeutung |
|------------------------|------------------------|------------------------|
| Person.ID | int | Kennung für jede Person |
| Gender | chr | Geschlecht ("Male"/"Female") |
| Age | int | Alter |
| Occupation | chr | Beruf |
| Sleep.Duration | dbl | Anzahl der Studen, die die Person am Tag schläft |
| Quality.of.Sleep | int | Subjektive Bewertung der Schlafqualität (1-10) |
| Physical.Activity.Level | int | Tägliche Aktivität in Minuten |
| Stress.Level | int | Subjektive Bewertung des Stresslevels (1-10) |
| BMI.Category | chr | BMI Kategorie |
| Blood.Pressure | char | Blutdruck (sysolisch/diastolisch) |
| Hearth.Rate | int | Ruheherzfrequenz |
| Daily.Steps | int | Tägliche Schritte |
| Sleep.Disorder | chr | Schlafstörung (Keine, Insomnie, Schlafaqnoe) |

Zunächst verschaffen wir uns einen Überblick über die Daten.

```{r, message=FALSE}
glimpse(sleep_data)
summary(sleep_data)
```

```{r, message=FALSE}
sleep_data %>% describe()
sleep_data %>% describe_tbl()
```

*Person.ID* nummeriert lediglich die verschiedenen Personen durch und ist deshalb für uns nicht relevant. Auch die Variable *Occupation* liefert uns keine relevanten Informationen. Aus diesem Grund werden wir *Person.ID* und *Occupation* später aus dem Datensatz entfernen.

Ansonsten scheint der Rest der Daten relevant und korrekt zu sein.

# Daten aufbereiten

Erstellen wir unseren finalen Datensatz und entfernen alle nicht relevanten Variableln.

```{r, message=FALSE}
final_sleep_data <- 
  sleep_data %>% 
  select(-Person.ID, -Occupation)
```

Das Geschlecht ist eine kategorschie Variable. Wandeln wird sie für eine einfachere weiterverarbeitung in einen Faktor um.

```{r, message=FALSE}
final_sleep_data$Gender <-
  as.factor(final_sleep_data$Gender)
```

Da für uns nicht relevant ist um welche Schlafstörung es sich genau handelt, geben wir nur an ab eine Schlafstörung vorhanden ist.

```{r, message=FALSE}
final_sleep_data <- 
  final_sleep_data %>% 
  mutate(Sleep.Disorder = Sleep.Disorder != "None")
```

Um die Lesbarkeit zu verbesser wandel wir die *Sleep.Discorder* Variable, zu zwei Kategorien um.

```{r, message=FALSE}
final_sleep_data$Sleep.Disorder <-
  if_else(final_sleep_data$Sleep.Disorder, "Hat Schlafstörung", "Hat keine Schlafstörung") %>%
  as_factor()
```

Um die Weiterverarbeitung zu vereinfachen, wandeln wir die *BMI.Category* zu einem Faktor um. Dabei bearchten wir aber auch die Reihenfolge der Kategorien.

Dazu schauen wir uns erstmal an welche Kategorien in *BMI.Category* enthalten sind.

```{r, message=FALSE}
unique(final_sleep_data$BMI.Category)
```

Es gibt 4 Kategorien. Sortiert ergibt das also: *"Normal" \< "Normal Weight" \< "Overweight" \< "Obese"*

```{r, message=FALSE}
final_sleep_data$BMI.Category <-
  final_sleep_data$BMI.Category %>%
  factor(
    levels = c("Normal", "Normal Weight","Overweight", "Obese"),
    ordered = TRUE
    )
```

Die Variable *Blood.Pressure* ist als String im Datenset. Wir teilen die Variable in den Systolisch und Diastolischen Wert auf und Wandeln ihn in eine Integer um.

```{r}
final_sleep_data <-
  final_sleep_data %>%
  separate_wider_delim(
    Blood.Pressure,
    delim = "/",
    names = c("BD.Systolisch", "BD.Diastolisch")
  )
```

Am Ende werfen wir noch einen kurzen Blick ins finale Datenset.

```{r, message=FALSE}
knitr::kable(head(final_sleep_data), caption = "Das Finale Datenset")
glimpse(final_sleep_data)
```

Nach dem wir das Datensetz fertig aufbereiten haben, widmen wir uns um unserer ersten These.

# Modell bilden

## Testdaten Beiseite legen

Damit sich keine Data-Snooping-Bias entwickelt legen wir bereite am Anfang einen Teil der Daten Beiseite. Diese werden wir dann am Ende dazu verwenden, um das Modell auf noch nicht gelesende Daten zu teste.

```{r}
set.seed(1337)
sleep_data_split <- initial_split(final_sleep_data, prop = 0.80, Quality.of.Sleep)
sleep_data_split
```

```{r}
final_sleep_data_train <- training(sleep_data_split)
final_sleep_data_test <- testing(sleep_data_split)
final_sleep_data <- final_sleep_data_train
```

## Explorative Datenanalyse

### Untersuchung der ersten These

Zunächst untersuchen wie sich Stress auf die Schlafqulität auswirk. Dabei vergleichen wird die Variabel *Stress.Level* mit der Variabel *Quality.of.Sleep*.

```{r, message=FALSE}
ggplot(
  data = final_sleep_data,
  mapping = aes(x = Stress.Level, y = Quality.of.Sleep)
) +
  geom_smooth() +
  geom_count() +
  labs(
    title = "Stress und Schlafqualität",
    x = "Stresslevel (1 - 10)", 
    y = "Schlafqualität (1 - 10)"
  )
```

Die Grafik zeigt, dass die Schlafqualität mit zunehmenden Stress abnimmt.

Die Schlafqualität bleibt in einem Bereich von 4 bis 9. Wobei der Durschnitt **`r mean(final_sleep_data$Quality.of.Sleep)`** beträgt.

Bis zu einem Stresslevel von 6 bleibt die Schlafqulität somit über dem Durschnittund befindet sich relativ zum Datensatz im höheren Bereich. Ab einen Stresslevel von 6 fällt die Schlafqulität hingegen unter den Durchschnitt.

Dabei ist zu beachten, dass es sich um subjektive Daten handelt. Um eine genauers Bild zu erhalten, betrachten wir im Folgenden, wie sich Stress auf die Schlafstörungen auswirkt. Dazu betrachen wir, wie groß der Anteil der Personen ist, die an Schlafstörungen leiden.

```{r}
stress_sleep_dis <- final_sleep_data %>%
  group_by(Stress.Level) %>%
  summarise(
    percent_sleep_disorder = sum(Sleep.Disorder == "Hat Schlafstörung") / (sum(Sleep.Disorder == "Hat keine Schlafstörung") + sum(Sleep.Disorder == "Hat Schlafstörung"))
  )

stress_sleep_dis %>%
  ggplot(mapping = aes(x = Stress.Level, y = percent_sleep_disorder)) +
  geom_col() +
  scale_x_continuous(breaks = 1:10) +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Stress und Schlafstörungen",
    subtitle = "Anzahl der Schlafstörung relativ zu den Gesamten Personen",
    x = "Stresslevel (1 - 10)",
    y = "Schlafstörungen Anteil in %"
  )
```

Wie zu erkenne ist, liegt der Anteil der Schlafstörungen bei einem Stresslevel von 1 bis 6 unter 50 Prozent. Man kann sogar einen Abfall der Schlafstörungen, bis zu einem Stresslevel von 6 erkennen. Ab dem Stresslevel von 6 steigt der Anteil der Schlafstörungen jedoch deutlich an.

Trotz des anfänglischen Rückangs kann man sagen, dass ein höheres Stresslevel mit einem erhöhten Auftreten von Schlafstörungen einhergeht. Damit bestätigen sich die vorherigen Ergebnisse.

Schauen wir uns als nächstes an wie sich Körperliche Aktivität auf die Schlafqulität auswirkt.

```{r, message=FALSE}
final_sleep_data %>%
  ggplot(
    mapping = aes(x = Physical.Activity.Level, y = Quality.of.Sleep)
  ) +
  geom_smooth() +
  geom_count(mapping = aes(color = Stress.Level)) +
  scale_x_continuous(breaks = seq(0, 100, by = 10)) +
  labs(
    title = "Körperliche Aktivität, Schlafqualität und Stress",
    x = "Täglische Körperliche Aktivität in Minuten", 
    y = "Schlafqualität (1 - 10)",
    color = "Stresslevel"
  )
```

Es zeigt sich kein eindeutiger Zusammenhang zwischen körperlicher Aktivität und Schlafqualität. Es lässt sich jedoch leichten anstiegt erkennen. Zudem sind zwei größere Außreißer scihbar. Einen bei einer guten Schlafqulität trotz Körperlicher Aktivität und einer bei schlechter Schlafqulität trotz hoher Körperlicher Aktivität. Diese habe jedoch ein hohes und niedriges Stresslevel. Die Schlafqualität ist also stark von Stresslevel beeflusst.

**Insgesamt deutet die Analyse darauf hin, dass Stress einen stärkeren Einfluss auf die Schlafqulität hat als die körperliche Aktivität.**

Um ein noch genaueres Bild zu erhalten, betrachen wim im Folgenden die Verteilung der Schlafstörungen auf die Körperliche Aktivität an.

```{r}
final_sleep_data %>%
  ggplot(
    mapping = aes(x = Physical.Activity.Level, y = Sleep.Disorder)
  ) +
  geom_boxplot() +
  scale_x_continuous(breaks = seq(0, 100, by = 10)) +
  theme(axis.title.y = element_blank()) +
  labs(
    title = "Schlafstörung und Köperliche Aktivität",
    x = "Täglische Körperliche Aktivität in Minuten"
  )
```

Man kann zu beiden Graphen sagen, dass sie eine große Spannweite haben. Somit gibt es keine klare Trennung zwichen den beiden Gruppen.

Bei Personen ohne Schlafstörung liegt der Median der täglichen körperlichen Aktivität höher als bei Peronsonen mit Schlafstörungen, was darauf hindeutet, dass erstere mehr körperliche Aktivität ausüben. Gleichzeitig ist das untere Quartil bei Personen mit Schlafstörungen höher als bei Personen ohne.

Das bedeute, dass die am wenigster aktiven Personen dennoch ein höhes Körperliche Aktivität aufweisen als weniger aktiven Personen ohne Schlafstörung.

Dies deutet darauf hin, dass die Körperliche Aktivität keinen eindeutigen Zusammenhang mit dem Auftreten von Schafstörungen zeigt.

Schauen wir zusätzlich zur Körperlichen Aktivität auch noch die Täglische Schrittzahl an.

```{r message=FALSE, warning=FALSE}
final_sleep_data %>%
  ggplot(
    mapping = aes(x = Daily.Steps, y = Quality.of.Sleep)
  ) +
  geom_smooth() +
  geom_count(mapping = aes(color = Stress.Level)) +
  labs(
    title = "Tägliche Schritte und Schlafqualität",
    x = "Tägliche Schritte", 
    y = "Schlafqualität (1 - 10)",
    color = "Stresslevel"
  )
```

Auch die Strittzahl zeigt keinen eindeutigen Zusammenhang zur Schlafqualität. Der Stärkere Auslößer scheint auch hier das Stresslevel zu sein.

Zusätzlich vergleichen wir, ob die Anzahl der Täglischen Schritte einen Zusammenhang mit Schlafstörungen hat.

```{r}
final_sleep_data %>%
  ggplot(
    mapping = aes(x = Daily.Steps, y = Sleep.Disorder)
  ) +
  geom_boxplot() +
  theme(axis.title.y = element_blank()) +
  labs(
    title = "Schlafstörung und Täglische Schritte",
    x = "Tägliche Schritte"
  )
```

Ähnlich wie im Diagramm *Schlafstörungen und körperliche Aktivität* weisen Personen ohne Schlafstörung eine größere Spannweite sowie ein höheren Median als Personen mit Schlafstörungen auf. Personen mit Schlafstörungen zeigen hingegen eine geringer Spannweite. Der Median liegt zwar niedriger, jedoch ist das untere Quartil höher als bei Personen ohne Schlafstörung.

Insgesamt ähnelt sich dieses Diagramm stark dem Diagramm *Schlafstörungen und körperliche Aktivität*. Lediglich der obere Quartil der Personen mit Schlafstörung fällt im Vergleich etwas niedriger aus. Trotz dieser Unterschiede lässt sich keine eindeutiger Zusammenhang zwischen der täglischen Strittzahl und dem Auftreten von Schlafsörungen erkennen.

Aus den Diagrammen ergibt sich also:

**Körperliche Aktivität scheint die Schlafqulität nicht zu beeinflussen**

Somit lässt sich die These nur zum Teil bestätigen. Wenig Stress hat einen großen Einfluss auf die Schlafqualität. Dagegen hat die Köperliche Aktivität keinen oder nur einen kleinen Einfluss auf die Schlafqualität.

**Möglichkeites besser moruk**

### Untersuchung der zweiten These

Zunächst werfen wir einen Blick auf den Zusammenhang zwischen Alter und der Schlafqulität.

```{r, message=FALSE, warning=FALSE}
ggplot(
  data = final_sleep_data,
  mapping = aes(x = Age, y = Quality.of.Sleep)
) + 
  geom_smooth() +
  geom_count() +
  labs(
    title = "Alter und Schlafqualität",
    x = "Alter", y = "Schlafqualität"
  )
```

In der Grafik ist erkannbar, dass die Schlafqualität mit zunehmendem Alter ansteigt. Er steigt aber nicht linear. Im Bereicht vom Alter 37 bis zum Alter 47 gibt es einen Rückgang der Schlafqualität.

Somit ergibt sich leicht positve Korrelation von **`r cor(final_sleep_data$Quality.of.Sleep, final_sleep_data$Age)`**.

Schauen wird uns ergänzent zu dem noch an, wie sich das Alter auf die Schlafstörungen auswirkt.

```{r}
ggplot(
  data = final_sleep_data,
  mapping = aes(x = Age, y = Sleep.Disorder)
) +
  geom_boxplot()
```

Der Graph zeigt, dass Schlafstörungen häufiger im hohen Alter auftreten. Dieses Ergebnis steht im Kontrast zum vorherigen Graphen, der einen Anstieg der Schlafqualität mit zunehmendem Alter zeigt.

Dabei ist jedoch zu berücksichtigen, dass es sich hirbei um eine Schwach positive Korrelation handelt. Zudem ist die Schlafqualität eine subjektive Variable. Darüber hinaus verläuft die Entwicklung nicht linear, sonder sinkt zwichendurch.

Allem im alles kann man also sagen, dass der zweige Graph eindeutigere Ergebnisse liefert. Somit wiederlegt sich die am anfang Aufgestellet These. Schlafqulität scheint im Alter schlechter zu werden. Jedoch kann man nicht sagen, dass dies ein eindeutiges Ergebniss ist, da sich die Graphen teilweise wiedersprechen.

Um ein genauere Ergebniss zu bekommen müsste man sich noch weiter Daten anschauen. Insbesondere die Daten die im hohen Alter eine gute Schlafqulität aussagen, da dies wiedersprüchen zum zweiten Graphen sind. Man könne also versuchen sich die wiedersprüchleichen Daten durch andere Faktoren zu deuten.

## Daten aufbereiten

Bereit wir die Daten final auf um ein Trainier bereiten Datensatz zu erhalten.

```{r}
rec <- recipe(Quality.of.Sleep ~ ., data = final_sleep_data_train) |>
  step_impute_median(all_numeric_predictors()) |>
  step_dummy(all_nominal_predictors()) |>
  step_normalize(all_predictors()) 

prep_rec <- prep(rec)

train_ready <- bake(prep_rec, new_data = NULL)

train_ready
```

## Modellieren

### Lineare Regression

Trainieren wir zuerst ein **lineares Regressionsmodell**

```{r}
lm_model <- linear_reg() %>% 
  set_engine("lm")

lm_fit <- lm_model %>% 
  fit(Quality.of.Sleep ~ ., data = train_ready)

lm_fit %>% 
  extract_fit_engine() %>% 
  summary()
```

Schauen wir uns die Fehler der Vorhersage auf dem Gesamten Trainigsdatensatz an.

```{r, warning=FALSE}
pred_lm <- predict(lm_fit, new_data = train_ready)

compare_lm <- train_ready %>% 
  select(Quality.of.Sleep) %>% 
  bind_cols(pred_lm)

head(compare_lm)
```

Nun berechnen wird den RSME Wert. 

```{r}
rmse(compare_lm, Quality.of.Sleep, .pred)
```

Dieser liegt in einem guten Bereich. Somit scheinen die Vorhersagen vom Eigentlichen Wert nicht stark abzuweichen.

Da der RSME Wert so niedrig ist führen wir zudem noch eine Kreuzvalidierung durch um zu überprüfen ob Overfitting vorhanden ist.

```{r, message=FALSE}
cv_splits <- vfold_cv(train_ready, v = 10, strata = Quality.of.Sleep)

model_spec <- linear_reg () %>%
  set_engine("lm")

workflow_spec <- workflow() %>%
  add_model(model_spec) %>%
  add_formula(Quality.of.Sleep ~ .)

cv_results <- 
  workflow_spec %>% 
  fit_resamples(resamples = cv_splits, 
                control = control_resamples(save_pred = TRUE))

cv_results %>% collect_metrics()
```

Nun fällt der RSME Wert um einiges höher aus. Somit können wir davon ausgehen, dass es sich um Overfitting gehandelt hat.

Da wir eine hohe Abweichung bei den Vorhersagen habe schauen wir uns ein weiteres Modell an.

### Entscheindungsbaum

Schauen wir uns als nächste das **Entscheidungsbaum** Modell an.

```{r}
tree_mod <- decision_tree(mode = "regression") 

tree_fit <- tree_mod %>% 
  fit(Quality.of.Sleep ~ ., data = train_ready)
```

Betrachten wir auch hier die Fehler der Vorhersage auf dem Gesamten Trainigsdatensatz.

```{r}
pred_tree <- predict(tree_fit, new_data = train_ready)

compare_tree <- train_ready %>% 
  select(Quality.of.Sleep) %>%
  bind_cols(pred_tree)

head(compare_tree)
```

```{r}
rmse(compare_tree, Quality.of.Sleep, .pred)
```

Der RMSE Wert fällt besser aus, als der RMSE Wert nach der Kreuzvalidierung vom *Linearen Regressions* Modell.

Auch hier führen wir eine Kreuzvalidierung durch.

```{r}
cv_splits <- vfold_cv(train_ready, v = 10, strata = Quality.of.Sleep)

model_spec <- decision_tree () %>%
  set_mode("regression")

workflow_spec <- workflow() %>%
  add_model(model_spec) %>%
  add_formula(Quality.of.Sleep ~ .)

cv_results <- 
  workflow_spec %>% 
  fit_resamples(resamples = cv_splits, 
                control = control_resamples(save_pred = TRUE))

cv_results %>% collect_metrics()
```

Die Kreuzvalidierung ergibt einen RMSE Wert der höher ist also der RMSE Werte vom *Linearen Regressions* Modell.

Somit performed das Modell schlechter und wir versuchen noch ein anderes Modell.

### Random Forest

Trainieren wir also das **Random Forest** Modell.

```{r}
forest_mod <- rand_forest(trees = 100)  %>%  
    set_mode("regression") 

forest_fit <- forest_mod %>% 
  fit(Quality.of.Sleep ~ ., data = train_ready)
```

Schauen wir uns die Fehler der Vorhersage auf dem Gesamten Trainigsdatensatz an.

```{r}

pred_forest <- predict(forest_fit, new_data = train_ready)

compare_forest <- train_ready %>% 
  select(Quality.of.Sleep) %>%
  bind_cols(pred_forest)

head(compare_forest)
```

```{r}
rmse(compare_forest, Quality.of.Sleep, .pred)
```

Hier haben wir die geringsten RMSE Wert von alles bisher verwendente Modellen.

Führen wir auch hier eine Kreuzvalidierung aus.

```{r}
cv_splits <- vfold_cv(train_ready, v = 10, strata = Quality.of.Sleep)

model_spec <- rand_forest (trees = 100) %>%
  set_mode("regression")

workflow_spec <- workflow() %>%
  add_model(model_spec) %>%
  add_formula(Quality.of.Sleep~.)

cv_results <- 
  workflow_spec %>% 
  fit_resamples(resamples = cv_splits, 
                control = control_resamples(save_pred = TRUE))

cv_results %>% collect_metrics()
```

Der RMSE wert ist nur leicht höher als der vorherige und fällt im Gegensatz zu den vorherigen Modellen am Geringsten aus.

### Modelle optimieren

## Modell beurteilen

```{r}
test_ready <- bake(prep_rec, new_data = final_sleep_data_test)
```

```{r}
pred_test <- predict(forest_fit, new_data = test_ready)

compare_test <- test_ready |> 
  select(Quality.of.Sleep) |> 
  bind_cols(pred_test)
head(compare_test)

rmse(compare_test, Quality.of.Sleep, .pred)
```

# Evaluieren
